@using MudBlazor
@inject ThemeService ThemeService
@implements IDisposable

<MudThemeProvider Theme="@_currentTheme" />

<CascadingValue Value="@_currentTheme">
    @ChildContent
</CascadingValue>

@code {
    private MudTheme _currentTheme = new();

    /// <summary>
    /// Child content to render
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Gets or sets the default theme to use
    /// </summary>
    [Parameter]
    public ThemeDefinition? DefaultTheme { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        var initialTheme = DefaultTheme
            ?? ThemeService.CurrentTheme
            ?? ThemeService.AvailableThemes?.FirstOrDefault();

        if (initialTheme != null)
        {
            _currentTheme = initialTheme.Theme;
            ThemeService.SetTheme(initialTheme);
        }

        // Subscribe to theme changes
        ThemeService.ThemeChanged += OnThemeChanged;
    }

    private void OnThemeChanged(object? sender, ThemeDefinition theme)
    {
        _currentTheme = theme.Theme;
        StateHasChanged();
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
    }
}
